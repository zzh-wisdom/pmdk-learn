# libpmem2_unsafe_shutdown

在支持持久内存的系统中，**断电保护域**涵盖了一组资源，在断电的情况下，平台将从这些资源中将数据刷新到持久介质。存储在持久性介质上的数据在电源循环中得以保留。

硬件保证将存储在断电保护域中的所有数据刷新到持久性介质的功能。**然而，没有什么是绝对可靠的，持久内存硬件可能会暴露一个单调增加的不安全关闭计数器 (USC)，每次检测到上述机制的故障时，该计数器都会增加**。这允许软件发现正在运行的应用程序被导致不安全关机的电源故障中断的情况。未发现的不安全关机可能会导致静默数据损坏。

> 注意：不安全关机可能会损坏存储在设备、文件、文件集以及仅跨越文件一部分的映射中的数据。为简单起见，以上所有情况以下均称为文件。

## 不安全关机检测

软件可以通过观察应用程序启动期间不安全关闭计数值之间的**变化**来检测不安全关闭。任何变化都可能表明发生了不安全停机。

应用程序可以通过将从 pmem2_source_device_usc(3) 检索到的 USC 值**存储在持久内存中**来实现检测机制。然后，在后续启动时，必须**将存储的值与新检索的值进行比较**。

但是，这种检测方法可能会导致误报。**将文件移动到可能具有不同 USC 值的不同持久性内存设备**会导致错误的不安全关闭检测。

此外，仅依赖 USC 值可能会导致检测到在此类关闭没有机会影响应用程序使用的数据时发生的不安全关闭事件，例如，当没有任何活动正在使用文件时。（也会误判）

**通过将通过 pmem2_source_device_id(3) 获得的设备标识与 USC 一起存储，应用程序可以避免与移动文件相关的误报**。这使软件能够检查底层设备是否已更改，并在这种情况下重新初始化存储的 USC。

第二种行为，即检测可能不相关的不安全关闭事件（如果不是想要的），可以通过存储**指示文件是否正在使用的标志**以及所有其余相关信息来防止。

**通用软件不应假设平台上存在 USC**，而应适当处理它遇到的任何 PMEM2_E_NOSUPP。否则可能会导致软件对其支持的硬件产生不必要的限制，并会阻止，例如，在模拟 PMEM 上进行测试。
